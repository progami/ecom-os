name: Block Direct Pushes

on:
  push:
    branches:
      - main
      - dev

jobs:
  prevent-direct-push:
    runs-on: ubuntu-latest
    steps:
      - name: Check if PR merge or direct push
        run: |
          message="$(jq -r '.head_commit.message // ""' "$GITHUB_EVENT_PATH")"

          # Allow merge commits (regular merge)
          if [[ "$message" == Merge\ pull\ request* ]]; then
            echo "Regular merge commit detected; allowed."
            exit 0
          fi

          # Allow squash merges (contain PR number like "(#123)")
          if [[ "$message" =~ \(#[0-9]+\)$ ]]; then
            echo "Squash merge detected; allowed."
            exit 0
          fi

          # Allow rebase merges from GitHub (pusher is web-flow)
          pusher="$(jq -r '.pusher.name // ""' "$GITHUB_EVENT_PATH")"
          if [[ "$pusher" == "web-flow" ]]; then
            echo "GitHub web merge detected; allowed."
            exit 0
          fi

          echo "::error::Direct pushes to protected branches are not allowed. Open a pull request instead."
          exit 1
