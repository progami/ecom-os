name: CD

on:
  pull_request:
    branches:
      - dev
      - main
  push:
    branches:
      - dev
      - main
  workflow_dispatch:
    inputs:
      app:
        description: 'App to deploy (leave empty for auto-detect)'
        required: false
        type: choice
        options:
          - ''
          - ecomos
          - wms
          - website
          - xplan
          - hrms
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - main

env:
  ECOM_OS_DEV_DIR: /Users/jarraramjad/ecom-os-dev
  ECOM_OS_MAIN_DIR: /Users/jarraramjad/ecom-os-main

concurrency:
  group: cd-${{ github.ref_name }}-${{ github.event_name }}
  cancel-in-progress: true

jobs:
  detect-changes:
    runs-on: self-hosted
    outputs:
      ecomos: ${{ steps.changes.outputs.ecomos }}
      wms: ${{ steps.changes.outputs.wms }}
      website: ${{ steps.changes.outputs.website }}
      xplan: ${{ steps.changes.outputs.xplan }}
      hrms: ${{ steps.changes.outputs.hrms }}
      packages: ${{ steps.changes.outputs.packages }}
      any_app: ${{ steps.changes.outputs.any_app }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed apps
        id: changes
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ inputs.app }}" ]]; then
            echo "${{ inputs.app }}=true" >> "$GITHUB_OUTPUT"
            echo "any_app=true" >> "$GITHUB_OUTPUT"
          else
            # For PRs, compare against base branch
            if [[ "${{ github.event_name }}" == "pull_request" ]]; then
              BASE="${{ github.event.pull_request.base.sha }}"
              HEAD="${{ github.event.pull_request.head.sha }}"
              CHANGED_FILES=$(git diff --name-only "$BASE" "$HEAD")
            else
              # For push, compare with previous commit
              CHANGED_FILES=$(git diff --name-only HEAD^ HEAD 2>/dev/null || git diff --name-only HEAD)
            fi

            echo "Changed files:"
            echo "$CHANGED_FILES"

            ANY_APP=false

            if echo "$CHANGED_FILES" | grep -q "^apps/ecomos/"; then
              echo "ecomos=true" >> "$GITHUB_OUTPUT"
              ANY_APP=true
            fi
            if echo "$CHANGED_FILES" | grep -q "^apps/wms/"; then
              echo "wms=true" >> "$GITHUB_OUTPUT"
              ANY_APP=true
            fi
            if echo "$CHANGED_FILES" | grep -q "^apps/website/"; then
              echo "website=true" >> "$GITHUB_OUTPUT"
              ANY_APP=true
            fi
            if echo "$CHANGED_FILES" | grep -q "^apps/x-plan/"; then
              echo "xplan=true" >> "$GITHUB_OUTPUT"
              ANY_APP=true
            fi
            if echo "$CHANGED_FILES" | grep -q "^apps/hrms/"; then
              echo "hrms=true" >> "$GITHUB_OUTPUT"
              ANY_APP=true
            fi
            if echo "$CHANGED_FILES" | grep -q "^packages/"; then
              echo "packages=true" >> "$GITHUB_OUTPUT"
              ANY_APP=true
            fi

            echo "any_app=$ANY_APP" >> "$GITHUB_OUTPUT"
          fi

  build-metadata:
    needs: detect-changes
    if: github.event_name == 'push' && needs.detect-changes.outputs.any_app == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.meta.outputs.version }}
      version_url: ${{ steps.meta.outputs.version_url }}
      commit_sha: ${{ steps.meta.outputs.commit_sha }}
      build_time: ${{ steps.meta.outputs.build_time }}
      tag: ${{ steps.meta.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute build metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          build_time="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          commit_sha="$(git rev-parse --short=8 HEAD)"

          exact_tag="$(git describe --tags --exact-match --match 'v[0-9]*.[0-9]*.[0-9]*' 2>/dev/null || true)"
          base_tag="$(git describe --tags --abbrev=0 --match 'v[0-9]*.[0-9]*.[0-9]*' 2>/dev/null || true)"
          create_release="false"

          if [[ -n "$exact_tag" ]]; then
            version="${exact_tag#v}"
            tag="$exact_tag"
          elif [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            if [[ -n "$base_tag" ]]; then
              range="${base_tag}..HEAD"
              base_version="${base_tag#v}"
            else
              range="HEAD"
              base_version="0.0.0"
            fi

            bump="patch"
            commit_messages="$(git log "$range" --pretty=%s%n%b)"

            if echo "$commit_messages" | grep -qE 'BREAKING CHANGE|^[a-zA-Z]+(\\(.+\\))?!:'; then
              bump="major"
            elif echo "$commit_messages" | grep -qE '^feat(\\(.+\\))?:'; then
              bump="minor"
            elif echo "$commit_messages" | grep -qE '^fix(\\(.+\\))?:'; then
              bump="patch"
            fi

            IFS='.' read -r major minor patch <<< "$base_version"
            major="${major:-0}"
            minor="${minor:-0}"
            patch="${patch:-0}"

            case "$bump" in
              major)
                major=$((major + 1))
                minor=0
                patch=0
                ;;
              minor)
                minor=$((minor + 1))
                patch=0
                ;;
              patch)
                patch=$((patch + 1))
                ;;
            esac

            version="${major}.${minor}.${patch}"
            tag="v${version}"
            create_release="true"
          else
            if [[ -n "$base_tag" ]]; then
              base_version="${base_tag#v}"
            else
              base_version="0.0.0"
            fi

            version="${base_version}-dev.${commit_sha}"
            tag="v${base_version}"
          fi

          if [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            version_url="https://github.com/${GITHUB_REPOSITORY}/releases/tag/${tag}"
          else
            version_url="https://github.com/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA}"
          fi

          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "version_url=$version_url" >> "$GITHUB_OUTPUT"
          echo "commit_sha=$commit_sha" >> "$GITHUB_OUTPUT"
          echo "build_time=$build_time" >> "$GITHUB_OUTPUT"
          echo "create_release=$create_release" >> "$GITHUB_OUTPUT"

      - name: Create GitHub release (main only)
        if: github.ref_name == 'main' && steps.meta.outputs.create_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: Release ${{ steps.meta.outputs.tag }}
          generate_release_notes: true

  # ===========================================
  # BUILD CHECK - Runs on PRs (blocks merge if fails)
  # ===========================================
  build-check:
    needs: detect-changes
    if: github.event_name == 'pull_request' && needs.detect-changes.outputs.any_app == 'true'
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        run: corepack enable && corepack prepare pnpm@10.21.0 --activate

      - name: Install dependencies
        run: pnpm install --frozen-lockfile 2>/dev/null || pnpm install

      - name: Prepare CI env files
        run: |
          # Next.js only auto-loads .env, .env.local, .env.production, etc.
          # For CI builds we copy committed .env.dev.ci â†’ .env.production when a production env file
          # is not present in the checkout (secrets files are not committed).
          for app_dir in apps/ecomos apps/wms apps/x-plan apps/hrms apps/website; do
            if [[ -f "$app_dir/.env.dev.ci" && ! -f "$app_dir/.env.production" ]]; then
              echo "Seeding $app_dir/.env.production from $app_dir/.env.dev.ci"
              cp "$app_dir/.env.dev.ci" "$app_dir/.env.production"
            fi
          done

      - name: Generate Prisma clients
        run: |
          pnpm --filter @ecom-os/wms db:generate || true
          pnpm --filter @ecom-os/x-plan prisma:generate || true
          cd apps/hrms && npx prisma generate || true

      - name: Build changed apps
        run: |
          echo "Building changed apps..."
          if [[ "${{ needs.detect-changes.outputs.ecomos }}" == "true" || "${{ needs.detect-changes.outputs.packages }}" == "true" ]]; then
            echo "Building ecomos..."
            pnpm --filter @ecom-os/ecomos build
          fi
          if [[ "${{ needs.detect-changes.outputs.wms }}" == "true" || "${{ needs.detect-changes.outputs.packages }}" == "true" ]]; then
            echo "Building wms..."
            pnpm --filter @ecom-os/wms build
          fi
          if [[ "${{ needs.detect-changes.outputs.website }}" == "true" || "${{ needs.detect-changes.outputs.packages }}" == "true" ]]; then
            echo "Building website..."
            pnpm --filter @ecom-os/website build
          fi
          if [[ "${{ needs.detect-changes.outputs.xplan }}" == "true" || "${{ needs.detect-changes.outputs.packages }}" == "true" ]]; then
            echo "Building x-plan..."
            pnpm --filter @ecom-os/x-plan build
          fi
          if [[ "${{ needs.detect-changes.outputs.hrms }}" == "true" || "${{ needs.detect-changes.outputs.packages }}" == "true" ]]; then
            echo "Building hrms..."
            cd apps/hrms && pnpm run build
          fi
          echo "All builds successful!"

  # ===========================================
  # DEPLOY - Only runs after merge (push event)
  # ===========================================
  deploy-ecomos:
    needs: [detect-changes, build-metadata]
    if: github.event_name == 'push' && (needs.detect-changes.outputs.ecomos == 'true' || needs.detect-changes.outputs.packages == 'true')
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Deploy ecomos
        env:
          NEXT_PUBLIC_VERSION: ${{ needs.build-metadata.outputs.version }}
          NEXT_PUBLIC_RELEASE_URL: ${{ needs.build-metadata.outputs.version_url }}
          NEXT_PUBLIC_COMMIT_SHA: ${{ needs.build-metadata.outputs.commit_sha }}
          BUILD_TIME: ${{ needs.build-metadata.outputs.build_time }}
        run: bash "${{ github.workspace }}/scripts/deploy-app.sh" ecomos "${{ github.ref_name }}"

  deploy-wms:
    needs: [detect-changes, build-metadata]
    if: github.event_name == 'push' && (needs.detect-changes.outputs.wms == 'true' || needs.detect-changes.outputs.packages == 'true')
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Deploy wms
        env:
          NEXT_PUBLIC_VERSION: ${{ needs.build-metadata.outputs.version }}
          NEXT_PUBLIC_RELEASE_URL: ${{ needs.build-metadata.outputs.version_url }}
          NEXT_PUBLIC_COMMIT_SHA: ${{ needs.build-metadata.outputs.commit_sha }}
          BUILD_TIME: ${{ needs.build-metadata.outputs.build_time }}
        run: bash "${{ github.workspace }}/scripts/deploy-app.sh" wms "${{ github.ref_name }}"

  deploy-website:
    needs: [detect-changes, build-metadata]
    if: github.event_name == 'push' && (needs.detect-changes.outputs.website == 'true' || needs.detect-changes.outputs.packages == 'true')
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Deploy website
        env:
          NEXT_PUBLIC_VERSION: ${{ needs.build-metadata.outputs.version }}
          NEXT_PUBLIC_RELEASE_URL: ${{ needs.build-metadata.outputs.version_url }}
          NEXT_PUBLIC_COMMIT_SHA: ${{ needs.build-metadata.outputs.commit_sha }}
          BUILD_TIME: ${{ needs.build-metadata.outputs.build_time }}
        run: bash "${{ github.workspace }}/scripts/deploy-app.sh" website "${{ github.ref_name }}"

  deploy-xplan:
    needs: [detect-changes, build-metadata]
    if: github.event_name == 'push' && (needs.detect-changes.outputs.xplan == 'true' || needs.detect-changes.outputs.packages == 'true')
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Deploy x-plan
        env:
          NEXT_PUBLIC_VERSION: ${{ needs.build-metadata.outputs.version }}
          NEXT_PUBLIC_RELEASE_URL: ${{ needs.build-metadata.outputs.version_url }}
          NEXT_PUBLIC_COMMIT_SHA: ${{ needs.build-metadata.outputs.commit_sha }}
          BUILD_TIME: ${{ needs.build-metadata.outputs.build_time }}
        run: bash "${{ github.workspace }}/scripts/deploy-app.sh" xplan "${{ github.ref_name }}"

  deploy-hrms:
    needs: [detect-changes, build-metadata]
    if: github.event_name == 'push' && (needs.detect-changes.outputs.hrms == 'true' || needs.detect-changes.outputs.packages == 'true')
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Deploy hrms
        env:
          NEXT_PUBLIC_VERSION: ${{ needs.build-metadata.outputs.version }}
          NEXT_PUBLIC_RELEASE_URL: ${{ needs.build-metadata.outputs.version_url }}
          NEXT_PUBLIC_COMMIT_SHA: ${{ needs.build-metadata.outputs.commit_sha }}
          BUILD_TIME: ${{ needs.build-metadata.outputs.build_time }}
        run: bash "${{ github.workspace }}/scripts/deploy-app.sh" hrms "${{ github.ref_name }}"

  # ===========================================
  # MANUAL DEPLOY - For workflow_dispatch
  # ===========================================
  manual-deploy:
    needs: detect-changes
    if: github.event_name == 'workflow_dispatch'
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Deploy selected app
        run: |
          APP="${{ inputs.app }}"
          ENV="${{ inputs.environment }}"
          if [[ -z "$APP" ]]; then
            echo "No app selected, deploying all changed apps..."
            [[ "${{ needs.detect-changes.outputs.ecomos }}" == "true" ]] && bash "${{ github.workspace }}/scripts/deploy-app.sh" ecomos "$ENV"
            [[ "${{ needs.detect-changes.outputs.wms }}" == "true" ]] && bash "${{ github.workspace }}/scripts/deploy-app.sh" wms "$ENV"
            [[ "${{ needs.detect-changes.outputs.website }}" == "true" ]] && bash "${{ github.workspace }}/scripts/deploy-app.sh" website "$ENV"
            [[ "${{ needs.detect-changes.outputs.xplan }}" == "true" ]] && bash "${{ github.workspace }}/scripts/deploy-app.sh" xplan "$ENV"
            [[ "${{ needs.detect-changes.outputs.hrms }}" == "true" ]] && bash "${{ github.workspace }}/scripts/deploy-app.sh" hrms "$ENV"
          else
            bash "${{ github.workspace }}/scripts/deploy-app.sh" "$APP" "$ENV"
          fi
