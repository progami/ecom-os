generator client {
  provider = "prisma-client-js"
  output   = "../../../packages/prisma-hrms/generated"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Employee {
  id               String         @id @default(cuid())
  employeeId       String         @unique
  googleId         String?        @unique  // Google Workspace user ID for sync
  firstName        String
  lastName         String
  email            String         @unique
  phone            String?
  avatar           String?

  dateOfBirth      DateTime?
  gender           String?
  maritalStatus    String?
  nationality      String?
  address          String?
  city             String?
  country          String?
  postalCode       String?

  // Primary department (backward compatible)
  department       String
  departmentId     String?
  dept             Department?    @relation(fields: [departmentId], references: [id])

  // Additional departments (many-to-many)
  departments      EmployeeDepartment[]

  position         String
  employmentType   EmploymentType  @default(FULL_TIME)
  joinDate         DateTime
  status           EmployeeStatus  @default(ACTIVE)

  // Reporting hierarchy (self-referential)
  reportsToId      String?
  manager          Employee?      @relation("EmployeeHierarchy", fields: [reportsToId], references: [id])
  directReports    Employee[]     @relation("EmployeeHierarchy")

  // Local override flags for Google sync
  nameLocalOverride        Boolean @default(false)
  departmentLocalOverride  Boolean @default(false)
  positionLocalOverride    Boolean @default(false)

  // Permission level: 0=regular, 50=manager, 100=super admin (root)
  permissionLevel  Int             @default(0)
  // Whether this employee is the super admin (root of the tree)
  isSuperAdmin     Boolean         @default(false)

  salary           Float?
  currency         String          @default("USD")

  emergencyContact String?
  emergencyPhone   String?

  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  files            EmployeeFile[]
  roles            Role[]
  performanceReviews PerformanceReview[]
  disciplinaryActions DisciplinaryAction[]
  notifications    Notification[]
  departmentsLed   Department[]    @relation("DepartmentHead")
  projectsLed      Project[]       @relation("ProjectLead")
  projectMemberships ProjectMember[]

  @@index([email])
  @@index([employeeId])
  @@index([department])
  @@index([departmentId])
  @@index([status])
  @@index([reportsToId])
  @@index([isSuperAdmin])
}

model EmployeeFile {
  id          String   @id @default(cuid())
  employee    Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId  String
  title       String
  fileUrl     String
  uploadedAt  DateTime @default(now())

  @@index([employeeId])
}

model Department {
  id          String     @id @default(cuid())
  name        String     @unique
  code        String?    @unique
  kpi         String?    // Key performance indicator for this department

  // Department head (who leads this department)
  headId      String?
  head        Employee?  @relation("DepartmentHead", fields: [headId], references: [id])

  // Nested department hierarchy
  parentId    String?
  parent      Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id])
  children    Department[] @relation("DepartmentHierarchy")

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  employees   Employee[]                // Primary department relationship
  members     EmployeeDepartment[]      // Additional department memberships

  @@index([headId])
  @@index([parentId])
}

// Many-to-many: Employee can belong to multiple departments
model EmployeeDepartment {
  id           String     @id @default(cuid())
  employeeId   String
  employee     Employee   @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  isPrimary    Boolean    @default(false)  // Is this the primary department?
  joinedAt     DateTime   @default(now())

  @@unique([employeeId, departmentId])
  @@index([employeeId])
  @@index([departmentId])
}

model Project {
  id          String        @id @default(cuid())
  name        String        @unique
  code        String?       @unique
  description String?
  status      ProjectStatus @default(ACTIVE)

  // Project lead
  leadId      String?
  lead        Employee?     @relation("ProjectLead", fields: [leadId], references: [id])

  // Team members
  members     ProjectMember[]

  startDate   DateTime?
  endDate     DateTime?

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([leadId])
  @@index([status])
}

model ProjectMember {
  id         String   @id @default(cuid())
  projectId  String
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  role       String?  // Role within the project (e.g., "Developer", "Designer")
  joinedAt   DateTime @default(now())

  @@unique([projectId, employeeId])
  @@index([projectId])
  @@index([employeeId])
}

enum ProjectStatus {
  PLANNING
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

model Role {
  id          String     @id @default(cuid())
  name        String     @unique
  description String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  employees   Employee[]
}

model Resource {
  id           String            @id @default(cuid())
  name         String
  category     ResourceCategory
  subcategory  String?
  description  String?
  contactName  String?
  email        String?
  phone        String?
  website      String?
  address      String?
  city         String?
  country      String?
  tags         String[]
  rating       Float?
  notes        String?

  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  @@index([category])
  @@index([category, subcategory])
  @@index([name])
}

model Policy {
  id            String        @id @default(cuid())
  title         String
  category      PolicyCategory
  region        Region
  summary       String?
  content       String?
  fileUrl       String?
  version       String        @default("1.0")
  effectiveDate DateTime?
  status        PolicyStatus  @default(ACTIVE)

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@unique([category, region])
  @@unique([effectiveDate])
  @@index([category])
  @@index([region])
  @@index([status])
}

model Notification {
  id            String           @id @default(cuid())
  type          NotificationType
  title         String
  message       String
  link          String?          // Optional link to related resource (e.g., /policies/xyz)

  // Target specific employee (null = broadcast to all)
  employeeId    String?
  employee      Employee?        @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // For tracking which record triggered the notification
  relatedId     String?
  relatedType   String?          // "POLICY", "REVIEW", etc.

  isRead        Boolean          @default(false)
  createdAt     DateTime         @default(now())

  @@index([type])
  @@index([isRead])
  @@index([createdAt])
  @@index([employeeId])
}

enum NotificationType {
  POLICY_CREATED
  POLICY_UPDATED
  POLICY_ARCHIVED
  ANNOUNCEMENT
  SYSTEM
  PROFILE_INCOMPLETE
  REVIEW_SUBMITTED
  REVIEW_ACKNOWLEDGED
  DISCIPLINARY_CREATED
  DISCIPLINARY_UPDATED
  HIERARCHY_CHANGED
  STANDING_CHANGED
}

// ============ CORE VALUES SYSTEM ============

enum CoreValue {
  ATTENTION_TO_DETAIL  // Quality & Precision (40%)
  HONESTY              // Communication & Transparency (20%)
  INTEGRITY            // Reliability & Ethics (20%)
  COURAGE              // Ownership & Initiative (20%)
}

enum ValueBreach {
  BREACH_OF_DETAIL     // Recurring mistakes, sloppy work - Training issue
  BREACH_OF_HONESTY    // Lying, falsifying records - Character issue
  BREACH_OF_INTEGRITY  // Theft, harassment, toxic behavior - Zero tolerance
  BREACH_OF_COURAGE    // Avoiding difficult tasks, hiding bad news - Coaching issue
}

enum EmployeeStanding {
  GREEN   // Role Model - No violations, review > 3.5, Honesty/Integrity > 3
  YELLOW  // Misaligned/Coaching - Minor violation or review 2.5-3.5
  RED     // Cultural Mismatch - Honesty/Integrity violation or review < 2.5
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERN
  WORKING_PARTNER
}

enum EmployeeStatus {
  ACTIVE
  ON_LEAVE
  TERMINATED
  RESIGNED
}

enum ResourceCategory {
  ACCOUNTING
  LEGAL
  DESIGN
  MARKETING
  IT
  HR
  OTHER
}

enum PolicyCategory {
  LEAVE
  PERFORMANCE
  CONDUCT
  SECURITY
  COMPENSATION
  OTHER
}

enum PolicyStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum Region {
  ALL
  KANSAS_US
  PAKISTAN
}

// ============ PERFORMANCE MANAGEMENT ============

model PerformanceReview {
  id              String              @id @default(cuid())
  employee        Employee            @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId      String
  reviewType      ReviewType
  reviewPeriod    String              // e.g., "Q1 2025", "Annual 2024"
  reviewDate      DateTime
  reviewerName    String

  // Legacy ratings (1-5 scale) - kept for backwards compatibility
  overallRating   Int                 // 1-5
  qualityOfWork   Int?                // 1-5
  productivity    Int?                // 1-5
  communication   Int?                // 1-5
  teamwork        Int?                // 1-5
  initiative      Int?                // 1-5
  attendance      Int?                // 1-5

  // Values-based ratings (1-5 scale) - Core Values System
  ratingPrecision     Int?            // Attention to Detail (40% weight)
  ratingTransparency  Int?            // Honesty - Communication & Transparency (20% weight)
  ratingReliability   Int?            // Integrity - Reliability & Ethics (20% weight)
  ratingInitiative    Int?            // Courage - Ownership & Initiative (20% weight)

  // Self-assessment ratings (employee fills these)
  selfRatingPrecision     Int?
  selfRatingTransparency  Int?
  selfRatingReliability   Int?
  selfRatingInitiative    Int?

  // Computed values score (weighted average, may be capped by Values Veto)
  valuesScore         Float?
  // Whether the Values Veto was applied (Honesty/Integrity < 3)
  valuesVetoApplied   Boolean         @default(false)
  valuesVetoReason    String?         // Explanation if veto applied

  // Required justification for low core values scores
  lowHonestyJustification    String?  // Required if ratingTransparency < 3
  lowIntegrityJustification  String?  // Required if ratingReliability < 3

  strengths       String?
  areasToImprove  String?
  goals           String?
  comments        String?

  status          ReviewStatus        @default(DRAFT)

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([employeeId])
  @@index([reviewType])
  @@index([reviewDate])
  @@index([status])
}

model DisciplinaryAction {
  id              String              @id @default(cuid())
  employee        Employee            @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId      String

  violationType   ViolationType
  violationReason ViolationReason
  severity        ViolationSeverity

  // Core Values breach tracking
  primaryValueBreached    ValueBreach?        // Which core value was primarily compromised
  employeeTookOwnership   Boolean?            // Did the employee take ownership of the issue?
  // Auto-escalation: If ownership=false AND value=HONESTY, severity escalates
  severityEscalated       Boolean             @default(false)
  originalSeverity        ViolationSeverity?  // Original severity before escalation

  incidentDate    DateTime
  reportedDate    DateTime            @default(now())
  reportedBy      String

  description     String
  witnesses       String?
  evidence        String?             // file URLs or references

  actionTaken     DisciplinaryActionType
  actionDate      DateTime?
  actionDetails   String?

  followUpDate    DateTime?
  followUpNotes   String?

  status          DisciplinaryStatus  @default(OPEN)
  resolution      String?

  // Acknowledgment tracking - both employee and manager must acknowledge
  employeeAcknowledged     Boolean   @default(false)
  employeeAcknowledgedAt   DateTime?
  managerAcknowledged      Boolean   @default(false)
  managerAcknowledgedAt    DateTime?
  managerAcknowledgerId    String?   // Which manager acknowledged

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([employeeId])
  @@index([violationType])
  @@index([severity])
  @@index([status])
  @@index([incidentDate])
  @@index([primaryValueBreached])
}

model HRCalendarEvent {
  id              String              @id @default(cuid())
  title           String
  description     String?
  eventType       HREventType

  startDate       DateTime
  endDate         DateTime?
  allDay          Boolean             @default(true)

  // Optional link to related records
  employeeId      String?
  relatedRecordId String?             // ID of review, disciplinary action, etc.
  relatedRecordType String?           // "PERFORMANCE_REVIEW", "DISCIPLINARY", etc.

  googleEventId   String?             // For Google Calendar sync

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([eventType])
  @@index([startDate])
  @@index([employeeId])
}

enum ReviewType {
  PROBATION       // 90-day review
  QUARTERLY
  SEMI_ANNUAL
  ANNUAL
  PROMOTION
  PIP             // Performance Improvement Plan
}

enum ReviewStatus {
  DRAFT
  PENDING_REVIEW
  COMPLETED
  ACKNOWLEDGED
}

enum ViolationType {
  ATTENDANCE
  CONDUCT
  PERFORMANCE
  POLICY_VIOLATION
  SAFETY
  HARASSMENT
  INSUBORDINATION
  THEFT_FRAUD
  SUBSTANCE_ABUSE
  OTHER
}

enum ViolationReason {
  // Attendance
  EXCESSIVE_ABSENCES
  TARDINESS
  UNAUTHORIZED_LEAVE
  NO_CALL_NO_SHOW

  // Conduct
  UNPROFESSIONAL_BEHAVIOR
  DISRUPTIVE_CONDUCT
  INAPPROPRIATE_LANGUAGE
  DRESS_CODE_VIOLATION

  // Performance
  POOR_QUALITY_WORK
  MISSED_DEADLINES
  FAILURE_TO_FOLLOW_INSTRUCTIONS
  NEGLIGENCE

  // Policy
  CONFIDENTIALITY_BREACH
  DATA_SECURITY_VIOLATION
  EXPENSE_POLICY_VIOLATION
  IT_POLICY_VIOLATION

  // Safety
  SAFETY_PROTOCOL_VIOLATION
  EQUIPMENT_MISUSE

  // Serious
  HARASSMENT_DISCRIMINATION
  WORKPLACE_VIOLENCE
  THEFT
  FRAUD
  FALSIFICATION
  SUBSTANCE_USE_AT_WORK

  OTHER
}

enum ViolationSeverity {
  MINOR           // Verbal warning
  MODERATE        // Written warning
  MAJOR           // Final warning / Suspension
  CRITICAL        // Termination consideration
}

enum DisciplinaryActionType {
  VERBAL_WARNING
  WRITTEN_WARNING
  FINAL_WARNING
  SUSPENSION
  DEMOTION
  TERMINATION
  PIP             // Performance Improvement Plan
  TRAINING_REQUIRED
  NO_ACTION       // Investigation found no violation
}

enum DisciplinaryStatus {
  OPEN
  UNDER_INVESTIGATION
  ACTION_TAKEN
  APPEALED
  CLOSED
  DISMISSED
}

enum HREventType {
  PERFORMANCE_REVIEW
  PROBATION_END
  PIP_REVIEW
  DISCIPLINARY_HEARING
  INTERVIEW
  ONBOARDING
  TRAINING
  COMPANY_EVENT
  HOLIDAY
  OTHER
}
