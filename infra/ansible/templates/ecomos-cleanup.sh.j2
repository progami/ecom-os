#!/usr/bin/env bash
set -euo pipefail

log() {
  printf "%s %s\n" "$(date -u '+%Y-%m-%dT%H:%M:%SZ')" "$1"
}

run_as_ubuntu() {
  su - ubuntu -s /bin/bash -c "$1"
}

log "starting ecomos cleanup"

run_as_ubuntu "rm -rf ~/.npm ~/.cache/ms-playwright ~/.cache/puppeteer ~/.cache/playwright ~/.cache/npm || true" || log "warning: failed to clear ubuntu caches"

if command -v pnpm >/dev/null 2>&1; then
  run_as_ubuntu "pnpm store prune || true" || log "warning: pnpm store prune failed"
else
  log "warning: pnpm not found on path; skipping pnpm store prune"
fi

run_as_ubuntu "rm -f ~/.pm2/logs/*.log* || true"

journalctl --vacuum-time=14d || log "warning: journalctl vacuum failed"
truncate -s0 /var/log/nginx/access.log /var/log/nginx/error.log 2>/dev/null || true
find /var/log -type f -name '*.gz' -delete || true
find /var/log -type f -name '*.log.*' -delete || true

apt-get clean || log "warning: apt-get clean failed"
rm -rf /var/lib/apt/lists/* || true
rm -rf /var/lib/snapd/cache/* || true

log "cleanup completed"
